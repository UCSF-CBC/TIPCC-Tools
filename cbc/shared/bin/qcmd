#!/usr/bin/env bash
### USAGE:
### qcmd [qsub options] --exec <command> [command options]
###
### EXAMPLES:
### qcmd --exec gzip *.txt
### qcmd -l nodes=1:ppn=4 --exec echo 'PBS_NUM_PPN=$PBS_NUM_PPN'
### qcmd -l nodes=1:ppn=4 --exec bash -c export
###
### AUTHOR:
### Henrik Bengtsson, 2016

action=help
verbose=FALSE
dryrun=FALSE

qsub_options=
cmd=
cmd_options=

state=0
for arg in $*; do
  if [[ $state == 0 ]]; then
    if [[ $arg == "--help" ]]; then
      action=help
      break
    elif [[ $arg == "--verbose" ]]; then
      verbose=TRUE
    elif [[ $arg == "--dryrun" ]]; then
      dryrun=TRUE
    elif [[ $arg == "--exec" ]]; then
      action=submit
      state=1
    else
      qsub_options=($qsub_options "$arg")
    fi
    shift
  elif [[ $state == 1 ]]; then
    cmd=$1
    state=2
    shift
  elif [[ $state == 2 ]]; then
    cmd_options=($cmd_options "$arg")
   shift
  fi
done

if [[ $action == "help" ]]; then
  grep "^###" $0 | grep -v "^####" | cut -b 5-
elif [[ $state == 1 || $state == 2 ]]; then
  ## Override default qsub options
  qsub_defaults="-d $(pwd)"
  qsub_defaults="$qsub_defaults -N $(basename $cmd)_$(date +%H%M%S-%Y%m%d)"
  qsub_defaults="$qsub_defaults -j oe"

  if [[ $verbose == "TRUE" ]]; then
    echo "VERBOSE OUTPUT:"
    echo "qsub_defaults: $qsub_defaults"
    echo "qsub_options: ${qsub_options[@]}"
    echo "cmd: $cmd"
    echo "cmd_options: ${cmd_options[@]}"
    echo "Manual call: echo \"$cmd ${cmd_options[@]}\" | qsub $qsub_defaults ${qsub_options[@]} -"
    echo
  fi
  
  if [[ ! -x "$cmd" && ! -x "$(which $cmd 2> /dev/null)" ]]; then
    echo "ERROR: No such command: $cmd"
    exit
  fi

  echo "echo \"$cmd ${cmd_options[@]}\" | qsub $qsub_defaults ${qsub_options[@]} -"
  if [[ $dryrun == "TRUE" ]]; then
    echo "Nothing evaulated (--dryrun)"
  else
    echo "$cmd ${cmd_options[@]}" | qsub $qsub_defaults ${qsub_options[@]} -
  fi
fi
