#!/usr/bin/env bash
#

## Parse command-line options
version=
verbose=false
asan=false
while (( "$#" )); do
  if test $1 == "--verbose" || test $1 == "-v"; then
    shift
    verbose=true
  elif test $1 == "--asan"; then
    shift
    asan=true
  else
    version=$1
  fi
  shift
done


if test "${verbose}" == "true"; then
  echo "Parsed command-line options:"
  echo "  version: $version"
  echo "  verbose: $verbose"
fi

pathT=/cbc/shared/software
# Full (without ambigous ones without version number!)
knownVersions=$(ls $pathT | grep "R[-][0-9]+" | cut -c 3- | tr '\n' ' ')
# Same but without specific date version
knownVersions=$(ls $pathT | grep "R[-][0-9]" | grep -v "[-]20[0-9]" | cut -c 3- | tr '\n' ' ')

if test -z "$version"; then
  echo "Usage: . useR <version>"
  echo
  echo "Known versions: $knownVersions"
  echo
  echo "IMPORTANT: This script must be executed in the same shell in order to have an effect.  Hence the initial period above."
else
  pathnameT="$pathT/R-$version"
  if ! test -d "$pathnameT"; then
    echo "ERROR: The requested R version ('$version' => '$pathnameT') is not among the installed ones: $knownVersions"
#    exit 1
  else
    path0=$PATH
    path1=`echo $PATH | sed -e "s/R-[^/]*/R-$version/g;"`
    export PATH="$path1"
    R_CMD=R-$version
    unalias R
    unalias Rscript
    if test "${asan}" = "true"; then
      echo "Using ASAN/UBSAN:"
      echo GCC_HOME=${GCC_HOME}
      echo ASAN_OPTIONS=${ASAN_OPTIONS}
      echo ASAN_SYMBOLIZER_PATH=${ASAN_SYMBOLIZER_PATH}
      LD_PRELOAD="${GCC_HOME}/lib64/libubsan.so:${GCC_HOME}/lib64/libasan.so:${LD_PRELOAD}"
      echo LD_PRELOAD=${LD_PRELOAD}
      alias R="LD_PRELOAD=${LD_PRELOAD} $(which R)"
      alias Rscript="LD_PRELOAD=${LD_PRELOAD} $(which Rscript)"
      echo
    fi
    if test "${verbose}" = "true"; then
      echo $PATH
      echo "Environment variable 'R_CMD' set to '${R_CMD}'"
      echo 
    fi
  fi
fi
echo Now using:
which R
which Rscript
R --version | head -3 | grep -v Copyright

