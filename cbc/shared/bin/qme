#!/usr/bin/env bash

## Collect
jobs=$(qstat -n -1 -u $USER | grep $USER | grep -v ' C ' | grep -v ' E ')

## Prune
jobs=$(echo "$jobs" | sed 's/.cclc01.som.ucsf[ ]*/ /g')
jobs=$(echo "$jobs" | sed "s/batch[ ]*/ /g")
jobs=$(echo "$jobs" | sed "s/$USER[ ]*/ /g")

## Identify nodes
nodes=$(echo "$jobs" | sed 's|/.*||g' | sed -E 's/.*[ ]+//g' | sort -u)
nodes=$(echo "$nodes" | sort -n -t n -k 2)  ## Sort mixed numerals
nnodes=$(echo "$nodes" | wc -l)
nodes=$(echo $nodes) ## Paste to one string

## Count
njobs=$(echo "$jobs" | wc -l)
rjobs=$(echo "$jobs" | grep ' R ' | wc -l)
qjobs=$(echo "$jobs" | grep ' Q ' | wc -l)

## Jobs stats
stats="Number of jobs: $njobs ($rjobs running, $qjobs queued)"

## Report
echo "Username: $USER"
if test "$njobs" != "0"; then
    echo "Nodes used ($nnodes): $nodes"
    echo $stats
fi

if test "$#" == "0"; then
  if test "$njobs" != "0"; then
    echo "$jobs"
  fi
else
  tjobs=$(echo "$jobs" | cut -d '.' -f 1)
  echo "qstat $* $jobs"
  qstat $* $tjobs
fi

echo "Nodes used ($nnodes): $nodes"
echo $stats




