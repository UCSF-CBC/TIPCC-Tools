#!/usr/bin/env bash

## Collect
jobs=$(qstat -n -1 -u $USER | grep $USER | grep -v ' C ' | grep -v ' E ')

## Prune
jobs=$(echo "$jobs" | sed 's/.cclc01.som.ucsf[ ]*/ /g')
jobs=$(echo "$jobs" | sed "s/batch[ ]*/ /g")
jobs=$(echo "$jobs" | sed "s/$USER[ ]*/ /g")
jobs=$(echo "$jobs" | grep -v '^$')

## Identify nodes
nodes=$(echo "$jobs" | sed 's|/.*||g' | sed -E 's/.*[ ]+//g' | sort -u)
nodes=$(echo "$nodes" | sort -n -t n -k 2)  ## Sort mixed numerals
nodes=$(echo $nodes) ## Paste to one string
nnodes=$(echo $nodes | wc -w)

## Count
njobs=$(echo $jobs | wc -w)
rjobs=$(echo "$jobs" | grep ' R ' | wc -l)
qjobs=$(echo "$jobs" | grep ' Q ' | wc -l)

## Jobs stats
stats="Number of jobs: $njobs ($rjobs running, $qjobs queued)"

## Report
echo "Username: $USER"
if test "$njobs" != "0"; then
    echo "Nodes used ($nnodes): $nodes"
    echo $stats
fi

if test "$#" == "0"; then
  if test "$njobs" != "0"; then
    echo "Job ID  Job name         PID      NDS    TSK    RAM      Time S     Since   Nodes/cores"
    echo "------- ---------------- ------ ----- ------ ------ --------- - ---------   -----------"
    ##### 269203  async1262705617- 476252     1      1    --   99:23:59 R  00:10:56   n9/6
    echo "$jobs"
  fi
else
  tjobs=$(echo "$jobs" | cut -d '.' -f 1)
  echo "qstat $* $jobs"
  qstat $* $tjobs
fi

if test "$njobs" != "0"; then
    echo "Nodes used ($nnodes): $nodes"
fi
echo $stats




