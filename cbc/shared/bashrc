#!/usr/bin/env bash

###################################################################
# Author: Henrik Bengtsson <hb@biostat.ucsf.edu>
#
# Description:
# Sets up the PATH to use the most recent versions of software
# installed by different users.
#
# Usage:
# Add the following command to your ~/.bashrc script:
#   source /home/shared/cbc/bashrc
###################################################################

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Record original state
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if test "${PATH_SYSTEM}" == ""; then
  export PATH_SYSTEM=${PATH}
fi
if test "${LD_LIBRARY_PATH_SYSTEM}" == ""; then
  export LD_LIBRARY_PATH_SYSTEM=${LD_LIBRARY_PATH}
fi

# Setup SHARED_ROOT
export SHARED_ROOT=/home/shared/cbc

# Useful functions
source ${SHARED_ROOT}/bin/includes.bash


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Setup PATH depending on system
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
export PATH=${PATH_SYSTEM}
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH_SYSTEM}

# Added ~/bin/
if ! test -d "${HOME}/bin"; then
  mkdir ${HOME}/bin
fi
appendPath ${HOME}/bin


export HOST=`uname -n`
export HOST_SHORT=${HOST/.*/}
export ARCH=`uname -m`
export ISCOMPUTENODE=0
if [[ ${HOST_SHORT} =~ n[0-9]{1,2} ]]; then
  export ISCOMPUTENODE=1
fi
## echo ISCOMPUTENODE=$ISCOMPUTENODE


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# SETUP COMPUTE NODES
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
export CLUSTER_SCHEDULER="TORQUE"
export CLUSTER_HEADNODE="cclc01"
export CLUSTER_NODES="n0 n1 n2 n3 n4 n5 n6 n7 n8 n9 n10 n11 n12 n13 n14 n15 n17 n18 n19 n20 n21 n22 n23 n24 n25 n26 n27"

if [[ "${ISCOMPUTENODE}" = "1" ]]; then
    prependPath ${SHARED_ROOT}/bin/compute_nodes_only
fi


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# SHARED SOFTWARE
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
prependPath ${SHARED_ROOT}/bin
prependPath ${SHARED_ROOT}/local/bin


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# CBC-shared .bashrc.d/
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [[ -d "${SHARED_ROOT}/.bashrc.d" ]]; then
  if [[ -n "${BASHRC_DEBUG}" ]]; then >&2 echo "Sourcing ${SHARED_ROOT}/.bashrc.d ..."; fi
  for ff in $(find "${SHARED_ROOT}/.bashrc.d/" -type f ! -name '*~' | LC_ALL=C sort); do
    if [[ -n "${BASHRC_DEBUG}" ]]; then >&2 echo "${ff}"; fi
    source "${ff}"
  done
  if [[ -n "${BASHRC_DEBUG}" ]]; then >&2 echo "Sourcing ${SHARED_ROOT}/.bashrc.d ... done"; fi
fi
